\documentclass{beamer}
\usetheme{Boadilla}

% ------ Basic packages -------
%\usepackage[margin=1.2in]{geometry}	% smaller margins              
\usepackage[utf8]{inputenc}			%for æ,ø,å on mac
\usepackage{amsmath,amsfonts,amssymb,amsthm,mathtools} % for mathematics
\usepackage{hyperref}					   % Clickable links to urls, internal and external references etc.
\usepackage{fancyhdr}					  % trengs for topp- og bunntekster og sidetall
\usepackage{pdfpages}					 % for å hente in pdf
%\numberwithin{equation}{section} % sub-numbers for equations
\usepackage{cite}								% For sitater og referanser
\usepackage[square,sort]{natbib}				% For referanser i klamme-parenteser  

% ------ Figures/graphic -----
\usepackage{graphicx}						%Graphic package
\usepackage{xcolor}
\usepackage{multicol}						 % for multiple columns
\usepackage[font=small,labelfont=bf,textfont=normal, format=hang]{caption}	% Configuration of captions
\usepackage{subcaption,graphicx}
\usepackage{wrapfig}  						% Wrap text around figures	
\usepackage{float} 								% To place figures correctly
\usepackage{color}							   % muliggjør farget tekst
\usepackage{tcolorbox}					   % enables color boxes
\definecolor{light-gray}{gray}{0.95} %the shade of grey that stack exchange uses
\usepackage{multirow}						
\usepackage{bm}									% usepackage bold symbols
\usepackage{xspace}							 % trengs også for fete typer

% -------- TikZ --------
\usepackage{tikz}
\usetikzlibrary{shapes.geometric, arrows}
\usetikzlibrary{matrix,chains,positioning,decorations.pathreplacing,arrows}
\tikzstyle{startstop} = [rectangle, rounded corners, minimum width=1.8cm, minimum height=1cm,text centered, draw=black, fill=blue!40]
\tikzstyle{io} = [trapezium, trapezium left angle=80, trapezium right angle=100, minimum width=1cm, minimum height=1cm, text centered, draw=black, fill=blue!20]
\tikzstyle{process} = [rectangle, minimum width=2cm, minimum height=1cm, text centered, text width=2cm, draw=black, fill=blue!5]
\tikzstyle{decision} = [diamond, minimum width=2cm, minimum height=1cm, text centered, draw=black, fill=green!30]
\tikzstyle{arrow} = [thick,->,>=stealth]

% -------- Embedded code ----------
\usepackage{listings}
\usepackage{color}
\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}
\lstset{frame=tb,
	language=Matlab,
	aboveskip=3mm,
	belowskip=3mm,
	showstringspaces=false,
	columns=flexible,
	basicstyle={\small\ttfamily},
	numbers=none,
	numberstyle=\tiny\color{gray},
	keywordstyle=\color{blue},
	commentstyle=\color{dkgreen},
	stringstyle=\color{mauve},
	breaklines=true,
	breakatwhitespace=true,
	tabsize=4
}

%% Nye kommandoer/snarveier
%\newcommand{\pd}{\ensuremath{\partial}} 			 % <---------- Partial derivative
%\newcommand{\ul}{\ensuremath{\underline}} 			% <---------- underline for easier vector notation
%\newcommand{\D}{\mathrm{D}}							   % <---------- Material derivate
%\newcommand{\vb}{\bm {v}\xspace}						% <---------- bold,italic v
%\newcommand{\wb}{\bm {w}\xspace}					  % <---------- bold,italic w
%\newcommand{\ub}{\bm {u}\xspace}						% <---------- bold,italic u					
%\newcommand{\gb}{\bm {g}\xspace}					   % <---------- bold,italic g
%\newcommand{\rb}{\bm {r}\xspace}						 % <---------- bold,italic r
%\newcommand{\fb}{\bm {f}\xspace}						 % <---------- bold,italic f
%\newcommand{\Fb}{\bm {F}\xspace}						% <---------- bold,italic f
%\newcommand{\ib}{\bm {i}\xspace}						  % <---------- bold,italic i
%\newcommand{\jb}{\bm {j}\xspace}						  % <---------- bold,italic j
%\newcommand{\yb}{\bm {y}\xspace}						% <---------- bold,italic y
%\newcommand{\xb}{\bm {x}\xspace}						% <---------- bold,italic x
%\newcommand{\taub}{\bm {\tau}\xspace}				 % <---------- bold,italic tau
%\newcommand{\lambdb}{\bm {\lambda}\xspace}
%\newcommand{\til}{\ensuremath{\widetilde}} 		% <---------- tilde
%\newcommand{\mub}{\bm {\mu}\xspace}				% <---------- bold, italic mu	
%\newcommand{\h}{\ensuremath{\hat}} 					% <---------- hat
%\newcommand{\dr}{\mathrm{d}}								% <---------- derivate
% \renewcommand{\thefootnote}{\roman{footnote}}	% Fotnoter med romerske symboler istedenfor tall

%\renewcommand{\theenumii}{\theenumi.\arabic{enumii}.}	% Sub-enumeration with numbers 

% Første side 
\title{Experimental setup}
\subtitle{WRF configurations}
\author{Torgeir Blæsterdalen}
\institute{Department of Industrial Engineering, UiT-The Arctic University of Norway}
\date{\today}



% ------ Utseende og forside -----
\begin{document}
\begin{frame}
\titlepage
\end{frame}


\begin{frame}{Lecture topics}
\begin{enumerate}
	\item Dynamical solvers
	\item Map projections
	\item Namelist.wps (example)
	\item Numerics:Numerics: diffusion, damping and advection
	\item Physics parametrization schemes
	\item Namelist.input (example)
	\item Super-short on supercomputing
	\item Interactive jobs and jobscripts
	\item Example: Interactive node
	\item Example: Jobscript
\end{enumerate}
\end{frame}


\begin{frame}[fragile, allowframebreaks=1, t]{1. Dynamic solvers}
The WRF Software Framework (WSF) is a infrastructure that contains the WRF dynamical solver, physical packages and their interface to the solver.

The two available solvers are the Advances Research WRF (ARW) and the Nonhydrostatic Mesoscale Model (NMM). 
The dynamic solver is the key component of the modeling system. The ARW solver is primarily developed at the National Center of Atmospheric Reseach (NCAR), and the NMM is primarily developed at the National Centers for Environmental Prediction (NCEP). 

Some remarks on the comparisons between the cores
\begin{itemize}
	\item \citet{bernardetcomparison} aimed at determining the inter-core differences between the ARW and the NMM cores. They concluded that with their setup, there were no statistically significant difference between the cores. 
	\item The physics packages are largely shared by both ARW and NMM, but there are some schemes that are only compatible with either the ARW or the NMM solver.
	\item ARW allows two-way nesting and a flexible ratio of the domains, meaning that the ratio between the domains can be chosen freely \citep{skamarock2008description}.
\end{itemize}


\end{frame}



\begin{frame}{2. Map projections}
The ARW solver supports four map projections 

\begin{figure}[htp]
	\centering
	\begin{subfigure}{0.49\textwidth} 
		\centering
		\includegraphics[width=.9\textwidth]{../../Figures/ProjLamb}
	\end{subfigure}
	\begin{subfigure}{0.49\textwidth}
		\centering
		\includegraphics[width=.9\textwidth]{../../Figures/ProjMerc}
	\end{subfigure}
	\centering
	\begin{subfigure}{0.49\textwidth} 
		\centering
		\includegraphics[width=.9\textwidth]{../../Figures/ProjPolar}
	\end{subfigure}
	\begin{subfigure}{0.49\textwidth}
		\centering
		\includegraphics[width=1.1\textwidth]{../../Figures/ProjLonLat}
	\end{subfigure}
\end{figure}
\end{frame}




\begin{frame}
According to the ARW user's guide \citep{ARWuserguide} the projections are well suited for:
\vskip .6 cm
\begin{tabular}{r | p{8 cm}}
	Polar stereographic		&  High latitudes. Isotropic. \\
	Lambert conformal		&  Conformal and isotropic, meaning that shapes are preserved, but not areas. Suited for mid-latitudes 	\\
	Mercator						&  A cylindrical projection. Suited for low latitudes. \\
	Longitude-latitude		&  Required for global WRF simulations. Area preserved, but not shapes.
\end{tabular}
\end{frame}



%The ARW solver supports four map projections; the Lambert conformal, polar stereographic, Mercator and latitude-longitude projections \citep{skamarock2008description}. The Lambert conformal, polar stereographic and Mercator projections are all isotropic, meaning that the relation $\Delta x/\Delta y|_{earth}$ is constant everywhere on the sphere. As a rule of thumb, the polar stereographic projection is best suited for high latitudes, the Lambert conformal projection is well-suited for mid-latitude domains and the Mercator projection should be used for low latitudes \citep{ARWuser_guide}. The latitude-longitude projection is required for global WRF simulations.
%
%Because the Rieppi site is at the latitude 69 $^{\circ}$ N, the polar stereographic map projection is used. If any of the other projections were used, there would be larger distortion in the distances of the projected maps.



\begin{frame}[fragile, allowframebreaks=.9, t]{3. Namelist.wps (example)}
Full description on \url{http://www2.mmm.ucar.edu/wrf/users/docs/user_guide_V3/users_guide_chap3.htm#_Description_of_the_1}
\begin{lstlisting}[backgroundcolor = \color{light-gray}, language=bash]
&share
wrf_core = 'ARW',
max_dom = 3,
start_date = '2014-01-01_00:00:00','2014-01-01_00:00:00','2014-01-01_00:00:00',
end_date   = '2014-01-31_00:00:00','2014-01-31_00:00:00','2014-01-31_00:00:00',
interval_seconds = 21600
io_form_geogrid = 2,
/
&geogrid
parent_id         =   1,   1, 2,
parent_grid_ratio =   1,   3, 3,
i_parent_start    =   1,  25, 30,
j_parent_start    =   1,  25, 30,
e_we              =  100, 151, 301,
e_sn              =  100, 151, 301,
geog_data_res     = '2m','30s','30s',
dx = 18000,
dy = 18000,
map_proj = 'polar',
ref_lat   =  69.1867,
ref_lon   =  20.6804,
truelat1  =  69.0,
stand_lon =  20.0,
geog_data_path =  '/home/WRF/WPS_GEOG/'
/
&ungrib
out_format = 'WPS',
prefix = 'Rieppi_Jan',
/
&metgrid
fg_name = 'Rieppi_Jan'
io_form_metgrid = 2, 
/
\end{lstlisting}
\end{frame}



\begin{frame}{4. Numerics: diffusion, damping and advection}
\begin{itemize}
	\item Time-integration scheme option
		\begin{itemize}
			\item Leapfrog
			\item 2$^{nd}$ order Runge-Kutta
			\item 3$^{rd}$ order Runge-Kutta
		\end{itemize}
	\item Advection schemes: 2$^{nd}$-6$^{th}$ order
	\item Turbulence and mixing option
	\item Eddy coefficient option	
	\item Vertical damping
\end{itemize}
And many more. For the full list of diffusion, damping and advection options, go to \url{https://esrl.noaa.gov/gsd/wrfportal/namelist_input_options.html}
\end{frame}


\begin{frame}[fragile, allowframebreaks=1, t]{5. Physics parameterization schemes}
\begin{itemize}
	\item \textbf{Microphysics:} Handles water vapour, ice-phases, cloud and precipitation processes. Mixed-phase schemes should be used at grid sizes less than 10 km, espicially in terrains where there are much convection or icing. Mixed-phase are computational expensive and should not be used for coarse simulation domains.  
	\item \textbf{Cumulus parameterization:} Handles sub-grid-scale effects of convective and/or shallow clouds.  These schemes are only valid for grid sizes larger than 10 km because of the spatial resolution needed to release latent heat from the fluid columns at the WRF grids. 
	\item \textbf{Radiation:} Atmospheric heating from direct and diffuse radiation from the Sun and ground. In the WRF model, there are two types of radiation: shortwave and longwave. The only source of shortwave radiation is the Sun, including absorption, reflection and scattering of the molecules in the atmosphere. Longwave radiation includes thermal and infrared radiation emitted or absorbed by the gasses in the atmosphere or the ground.  
	\item \textbf{Surface layer (SL):} Calculates friction velocity at the model surface. Calculates for example surface heat, surface stress and moisture fluxes. 
	\item \textbf{Land-surface model (LSM):} Uses the calculations from the SL scheme, radiation from the radiation scheme and precipitation from the Microphysics scheme and merges these schemes along with the land's state variables, land-surface properties and calculates moisture fluxes over land and sea ice. This model handles lower boudary conditions for the vertical transport of for example thermal and moisture fluxes at the surface to the Planetary boundary layer. Vegetation, root and canopy effects are handled in the LSM model, as well as surface snow and ice conditions, soil moisture profile. 
	\item \textbf{Planetary boundary layer (PBL):} The lowest part of the atmosphere is known as the planetary boundary layer (PBL) or the atomspheric boundary layer. The PBL is extending from the ground surface to the so-called "free atmosphere" where the wind is at \textit{geostrophic balance}. The PBL schemes were developed for improved modelling the fluxes of heat, moisture and momentum in the atmosphere \citep{deppe2013wrf} and the accurate representation of meteorological condition at typical wind turbine heights depends on the correct parameterization scheme for the PBL. \citet{balzarini2014sensitivity} argues that PBL parameters are one of the most uncertain parameters in model estimates.
	
	The PBL schemes handles the vertical sub-grid-scale fluxes due to eddy transports in the atmospheric column. The surface fluxes are provided by the SL and LSM schemes. There are two types of available PBL parameterization schemes, namely first order closure schemes and turbulent kinetic energy closure schemes.  
\end{itemize}
\end{frame}

%\begin{frame}[fragile, allowframebreaks=1, t]{5. Physics parameterization schemes}
%\begin{itemize}
%	\item Microphysics
%	\item Cumulus parameterization 
%	\item Surface layer (SL)
%	\item Planetary boundary layer (PBL)
%\end{itemize}
%\end{frame}

\begin{frame}[fragile, allowframebreaks=.95, t]{6. Namelist.input (example)}
More thorough description at \url{https://esrl.noaa.gov/gsd/wrfportal/namelist_input_options.html}
\begin{lstlisting}[backgroundcolor = \color{light-gray}, language=bash]
&time_control
run_days                            = 01,
run_hours                           = 00,
run_minutes                         = 0,
run_seconds                         = 0,
start_year                          = 2014, 2014, 2014,
start_month                         = 01,   01,   01,
start_day                           = 02,   02,   02,
start_hour                          = 00,   00,   00,
start_minute                        = 00,   00,   00,
start_second                        = 00,   00,   00,
end_year                            = 2014, 2014, 2014,
end_month                           = 01,   01,   01,
end_day                             = 03,   03,   03,
end_hour                            = 00,   00,   00,
end_minute                          = 00,   00,   00,
end_second                          = 00,   00,   00,
interval_seconds                    = 21600
input_from_file                     = .true.,.true.,.true.,
history_interval                    = 10,  10,   10,
frames_per_outfile                  = 200000, 200000, 200000,
restart                             = .false.,
restart_interval                    = 500000,
io_form_history                     = 2
io_form_restart                     = 2
io_form_input                       = 2
io_form_boundary                    = 2
debug_level                         = 0
/

&domains
time_step                           = 90,
time_step_fract_num                 = 0,
time_step_fract_den                 = 1,
max_dom                             = 3,
e_we                                = 100,    151,   301,
e_sn                                = 100,    151,   301,
e_vert                              = 51,    51,    51,
p_top_requested                     = 1000,
num_metgrid_levels                  = 38,
num_metgrid_soil_levels             = 4,
dx                                  = 18000, 6000,  2000,
dy                                  = 18000, 6000,  2000,
grid_id                             = 1,     2,     3,
parent_id                           = 0,     1,     2,
i_parent_start                      = 1,     25,    30,
j_parent_start                      = 1,     25,    30,
parent_grid_ratio                   = 1,     3,     3,
parent_time_step_ratio              = 1,     3,     3,
feedback                            = 1,
smooth_option                       = 0
eta_levels =   1.0000, 0.9980, 0.9955, 0.9925, 0.9890, 0.9850,
0.9805, 0.9755, 0.9700, 0.9640, 0.9575, 0.9505,
0.9430, 0.9350, 0.9265, 0.9170, 0.9060, 0.8930,
0.8775, 0.8590, 0.8363, 0.8104, 0.7803, 0.7456,
0.7059, 0.6615, 0.6126, 0.5594, 0.5041, 0.4479,
0.3919, 0.3384, 0.2897, 0.2474, 0.2107, 0.1792,
0.1523, 0.1293, 0.1093, 0.0917, 0.0763, 0.0629,
0.0513, 0.0413, 0.0328, 0.0255, 0.0194, 0.0144,
0.0104, 0.0071, 0.0000,
/

&physics
mp_physics                          = 4,     4,     4,
ra_lw_physics                       = 5,     5,     5,
ra_sw_physics                       = 5,     5,     5,
radt                                = 9,     3,     1,
sf_sfclay_physics                   = 2,     2,     2,
sf_surface_physics                  = 2,     2,     2,
bl_pbl_physics                      = 2,     2,     2,
bldt                                = 0,     0,     0,
cu_physics                          = 2,     0,     0,
cudt                                = 5,     5,     5,
isfflx                              = 1,
ifsnow                              = 1,
icloud                              = 1,
surface_input_source                = 1,
num_soil_layers                     = 4,
sf_urban_physics                    = 2,     2,     2,
/
\end{lstlisting}
\end{frame}




\begin{frame}[fragile, allowframebreaks=.9, t]{7. Super-short on supercomputing}
Supercomputers are build up of individual computers referred to as \textit{nodes} or \textit{cores}. Super computers can be viewed as a large cluster of servers and storage interconnected by a network. The computers are typically run on the Linux operative system. 
Supercomputers are fast because the nodes are working together on big problems that requires parallelization.  Each node has one or more processors. 
Each Stallo-user has two main directories/disks
\begin{itemize}
	\item \texttt{home/<username>} : Maximum capacity of 200 GB. Files in this directory is backed up regularly. Good location for storing scripts, figures, etc. 
	\item \texttt{global/work/<username>} Not backed up and the HPC team are allowed to remove files in this directory. This is where one should run simulations and store big files. 
\end{itemize}
Login and computational nodes
\begin{itemize}
	\item Login node: For small tasks like  manage directories and submitting jobs. Never run calculations on the login node, this will reduce the speed for all users on the login node. 
	\item Computational nodes
\end{itemize}
For more info about Stallo, visit the HPC documentation web page \url{https://hpc-uit.readthedocs.io/en/latest/stallo/stallo.html}
\end{frame}

\begin{frame}[fragile, allowframebreaks=1,t]{8. Interactive jobs and jobscripts}
Calculations on Stallo is done by submitting jobs through a batch system that executes the job applications based on the available resources, like computational and time frame. Stallo's batch system is SLURM (Simple Linux Utility for Resource Management).

To submit a job and get access to the computational nodes one need to sumit a job application. This is done either by submitting a jobscript, or by using a computational node.

For interactive jobs or small tasks,  it is often useful to use a computational node.
The syntax for logging  into a computational node is:
\begin{lstlisting}[backgroundcolor = \color{light-gray}, language=bash]
srun --nodes=1 --ntasks-per-node=1 --time=00:10:00 --pty bash -i
\end{lstlisting}
The command prompt appears as the job has done queing and are being allocated the requested resources. When logged in on a computational node  one can see the node id, typically \texttt{blasterdalen@c12-16}
A jobscript is a shell script containing information of the resources required to run the job and a estimation of how long the job will last. 
When submitting the jobscript (also for applying to a computational node) the job is queued until the resources are allocated. 
\begin{lstlisting}[backgroundcolor = \color{light-gray}, language=bash]
sbatch jobscript.sh
\end{lstlisting}
Check job status by entering
\begin{lstlisting}[backgroundcolor = \color{light-gray}, language=bash]
squeue -u <user_name>
\end{lstlisting}
If the user needs to delete the job, this can be done by 
\begin{lstlisting}[backgroundcolor = \color{light-gray}, language=bash]
scancel <job_id>
\end{lstlisting}
\end{frame}


\begin{frame}[fragile, allowframebreaks=.95, t]{9. Example: Interactive node}
\vskip .6 cm
Make a MATLAB script that produces a output file 
\begin{lstlisting}[backgroundcolor = \color{light-gray}, language=bash]
vi Matlabtestscript.m
\end{lstlisting}
Load MATLAB module (can check if module is avail by entering \texttt{module avail matlab})
\begin{lstlisting}[backgroundcolor = \color{light-gray}, language=bash]
module load MATLAB/2015a-loc
\end{lstlisting}
Log into a interactive node
\begin{lstlisting}[backgroundcolor = \color{light-gray}, language=bash]
srun --nodes=1 --ntasks-per-node=1 --time=00:10:00 --pty bash -i
\end{lstlisting}
Run the MATLAB script
\begin{lstlisting}[backgroundcolor = \color{light-gray}, language=bash]
matlab -nodisplay -nodesktop -r "Postprocessing"
\end{lstlisting}
Download figure to local host
\begin{lstlisting}[backgroundcolor = \color{light-gray}, language=bash]
scp <username>@stallo.uit.no:/<path to file>/<filename> .
\end{lstlisting}
\end{frame}

\begin{frame}[fragile, allowframebreaks=.95, t]{10. Example: Jobscript}
This can also be done by submitting a jobscript, but first we have to make it:
\begin{lstlisting}[backgroundcolor = \color{light-gray}, language=bash]
vi ExampleJobscript.sh
\end{lstlisting}
And in the jobscript we write the commands that executes the MATLAB script:
\begin{lstlisting}[backgroundcolor = \color{light-gray}, language=bash]
#!/usr/bin/env bash
#:--------------------------------------------------------------------------
# Example-jobscript for sunmitting m-code
#
# 20.March.2018, Torgeir
#:-------------------------------------------------------------------------- 

#SBATCH --job-name=ExampleJobscript

# Stallo account to charge
#SBATCH -A <account id>

# Computation resources; nodes and cores
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1

# Runtime: d-hh:mm:ss  (set a bit higher than expected)
#SBATCH --time 0-00:10:00

# Load relevant modules
module load MATLAB/2015a-loc

# goes to the directory where the job was submitted
cd $SLURM_SUBMIT_DIR

matlab -nodisplay -nodesktop -r "Matlab_testscript"

exit 0
\end{lstlisting}
And finally, we submit the job 
\begin{lstlisting}[backgroundcolor = \color{light-gray}, language=bash]
sbatch ExampleJobscript.sh 
\end{lstlisting}
\end{frame}


\begin{frame}[fragile,allowframebreaks=1, t]{References}
\bibliographystyle{plainnat}
\bibliography{../References/References.bib}
\end{frame}

\end{document}
